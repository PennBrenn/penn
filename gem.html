<script>document.addEventListener("DOMContentLoaded", () => {
    // 1. Setup the Pet Element
    const pet = document.createElement("div");
    pet.id = "site-pet";
    document.body.appendChild(pet);

    // 2. Configuration
    const SETTINGS = {
        speed: 2,
        gravity: 0.8,
        bounce: 0.4, // How much it bounces when hitting the floor
        width: 96,
        height: 96,
        floorOffset: 0 // If you want it slightly above bottom
    };

    // 3. State Management
    let state = {
        x: window.innerWidth / 2,
        y: 0,
        vx: 0, // Velocity X
        vy: 0, // Velocity Y
        isDragging: false,
        action: 'falling', // 'walking', 'climbing', 'falling', 'dragged', 'idle'
        direction: 1, // 1 = right, -1 = left
        onGround: false
    };

    // Mouse Tracking
    let mouseX = 0;
    let mouseY = 0;

    // --- LOGIC LOOP ---
    function update() {
        const windowW = window.innerWidth;
        const windowH = window.innerHeight;

        // 1. Handle Dragging (Overrides all physics)
        if (state.isDragging) {
            state.x = mouseX - (SETTINGS.width / 2);
            state.y = mouseY - (SETTINGS.height / 2);
            state.vx = 0;
            state.vy = 0;
            setAnimation('picked-up');
        } 
        
        // 2. Handle Physics (Gravity)
        else {
            // Apply Gravity
            state.vy += SETTINGS.gravity;
            state.y += state.vy;
            state.x += state.vx;

            // Floor Collision
            if (state.y + SETTINGS.height >= windowH - SETTINGS.floorOffset) {
                state.y = windowH - SETTINGS.height - SETTINGS.floorOffset;
                state.vy *= -SETTINGS.bounce; // Small bounce
                state.onGround = true;
                
                // Friction to stop sliding
                state.vx *= 0.8;
            } else {
                state.onGround = false;
            }

            // Wall Collision (Climbing Logic)
            if (state.x <= 0) {
                state.x = 0;
                handleWallHit(-1);
            } else if (state.x + SETTINGS.width >= windowW) {
                state.x = windowW - SETTINGS.width;
                handleWallHit(1);
            }

            // AI Decision Making (The "Brain")
            if (state.onGround) {
                // Determine animation based on velocity
                if (Math.abs(state.vx) > 0.5) {
                    state.action = 'walking';
                    state.direction = state.vx > 0 ? 1 : -1;
                } else {
                    state.action = 'idle';
                    // Randomly decide to walk
                    if (Math.random() < 0.01) pickRandomWalk();
                }
            } else {
                state.action = 'falling';
            }

            // Mouse Following (Simplified)
            // If idle and mouse is close, look at it or walk to it
            if (state.action === 'idle' && Math.random() < 0.05) {
                const distToMouse = mouseX - state.x;
                if (Math.abs(distToMouse) < 300) {
                    state.vx = distToMouse > 0 ? 1 : -1; // Nudge towards mouse
                }
            }
        }

        // Apply Styles
        updateVisuals();
        
        requestAnimationFrame(update);
    }

    function handleWallHit(wallSide) {
        // wallSide: -1 is left, 1 is right
        // 50% chance to climb, 50% chance to turn around
        if (state.action !== 'climbing') {
            if (Math.random() > 0.5) {
                state.vx = -state.vx; // Turn around
                state.direction = state.vx > 0 ? 1 : -1;
            } else {
                // Start climbing (simple jump/climb effect)
                state.vy = -15; // Jump up
                state.action = 'climbing';
            }
        }
    }

    function pickRandomWalk() {
        state.vx = (Math.random() - 0.5) * SETTINGS.speed * 2;
        state.direction = state.vx > 0 ? 1 : -1;
    }

    // --- VISUALS ---
    function setAnimation(animName) {
        pet.className = ''; // Reset
        // Map logical state to CSS class
        // Logic to handle direction
        let dirStr = state.direction === 1 ? 'right' : 'left';

        if (animName === 'walking') pet.classList.add(`pet-walk-${dirStr}`);
        else if (animName === 'falling') pet.classList.add('pet-falling');
        else if (animName === 'picked-up') pet.classList.add('pet-picked-up');
        else if (animName === 'climbing') pet.classList.add(`pet-climb-${dirStr}`);
        else if (animName === 'hang') pet.classList.add('pet-hang');
    }

    function updateVisuals() {
        pet.style.left = `${state.x}px`;
        pet.style.top = `${state.y}px`;

        // If dragging, we handled animation in the loop. 
        // Otherwise, sync animation to state.
        if (!state.isDragging) {
            setAnimation(state.action);
        }
    }

    // --- EVENTS ---
    
    // Mouse Down (Start Drag)
    pet.addEventListener('mousedown', (e) => {
        e.preventDefault();
        state.isDragging = true;
        // Interaction: Maybe play a sound here?
    });

    // Mouse Move (Track Mouse)
    window.addEventListener('mousemove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
    });

    // Mouse Up (End Drag)
    window.addEventListener('mouseup', () => {
        if (state.isDragging) {
            state.isDragging = false;
            // Throwing physics
            state.vx = (Math.random() - 0.5) * 5; 
            state.vy = -5; // Slight pop up on release
        }
    });

    // Start Loop
    requestAnimationFrame(update);
});</script>
<style>/* The Pet Container */
#site-pet {
    position: fixed;
    width: 96px;
    height: 96px;
    z-index: 9999; /* Always on top */
    cursor: grab;
    pointer-events: auto;
    /* Fallback color if images are missing */
    background-color: rgba(255, 0, 0, 0.2); 
    background-repeat: no-repeat;
    background-size: contain;
}

#site-pet.dragging {
    cursor: grabbing;
}

/* --- ANIMATIONS --- */

/* 1. Walk Left */
@keyframes anim-walk-left {
    0% { background-image: url('./animations/walk_left/frame1.png'); }
    16% { background-image: url('./animations/walk_left/frame2.png'); }
    32% { background-image: url('./animations/walk_left/frame3.png'); }
    48% { background-image: url('./animations/walk_left/frame4.png'); }
    64% { background-image: url('./animations/walk_left/frame5.png'); }
    80% { background-image: url('./animations/walk_left/frame6.png'); }
}
.pet-walk-left { animation: anim-walk-left 0.6s infinite step-start; }

/* 2. Walk Right */
@keyframes anim-walk-right {
    0% { background-image: url('./animations/walk_right/frame1.png'); }
    16% { background-image: url('./animations/walk_right/frame2.png'); }
    32% { background-image: url('./animations/walk_right/frame3.png'); }
    48% { background-image: url('./animations/walk_right/frame4.png'); }
    64% { background-image: url('./animations/walk_right/frame5.png'); }
    80% { background-image: url('./animations/walk_right/frame6.png'); }
}
.pet-walk-right { animation: anim-walk-right 0.6s infinite step-start; }

/* 3. Falling */
@keyframes anim-falling {
    0% { background-image: url('./animations/falling/frame1.png'); }
    /* Add frames 2-6 if your falling animation has them */
}
.pet-falling { animation: anim-falling 0.6s infinite step-start; }

/* 4. Picked Up */
@keyframes anim-picked-up {
    0% { background-image: url('./animations/picked_up/frame1.png'); }
}
.pet-picked-up { animation: anim-picked-up 0.6s infinite step-start; }

/* 5. Climb Left */
@keyframes anim-climb-left {
    0% { background-image: url('./animations/climb_left/frame1.png'); }
    /* Add frames 2-6 here... */
}
.pet-climb-left { animation: anim-climb-left 0.6s infinite step-start; }

/* 6. Climb Right */
@keyframes anim-climb-right {
    0% { background-image: url('./animations/climb_right/frame1.png'); }
    /* Add frames 2-6 here... */
}
.pet-climb-right { animation: anim-climb-right 0.6s infinite step-start; }

/* 7. Hang */
@keyframes anim-hang {
    0% { background-image: url('./animations/hang/frame1.png'); }
}
.pet-hang { animation: anim-hang 0.6s infinite step-start; }</style>
